{"name": "Impacket Lateralization Detection", "description": "Detects wmiexec/dcomexec/atexec/smbexec from Impacket framework", "created": "2019-09-03T00:00:00.000Z", "valid_from": "2019-09-03T00:00:00Z", "indicator_types": ["malicious-activity"], "pattern_type": "sigma", "pattern": "title: Impacket Lateralization Detection\nid: 10c14723-61c7-4c75-92ca-9af245723ad2\nstatus: experimental\ndescription: Detects wmiexec/dcomexec/atexec/smbexec from Impacket framework\nreferences:\n    - https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py\n    - https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py\n    - https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py\n    - https://github.com/SecureAuthCorp/impacket/blob/master/examples/dcomexec.py\nauthor: Ecco\ndate: 2019/09/03\nlogsource:\n    category: process_creation\n    product: windows\ndetection:\n    selection_other:\n        # *** wmiexec.py \n        #    parent is wmiprvse.exe\n        #    examples:\n        #       cmd.exe /Q /c whoami 1> \\\\127.0.0.1\\ADMIN$\\__1567439113.54 2>&1\n        #       cmd.exe /Q /c cd  1> \\\\127.0.0.1\\ADMIN$\\__1567439113.54 2>&1\n        # *** dcomexec.py -object MMC20 \n        #   parent is mmc.exe\n        #   example:\n        #       \"C:\\Windows\\System32\\cmd.exe\" /Q /c cd  1> \\\\127.0.0.1\\ADMIN$\\__1567442499.05 2>&1\n        # *** dcomexec.py -object ShellBrowserWindow\n        #  runs %SystemRoot%\\System32\\rundll32.exe shell32.dll,SHCreateLocalServerRunDll {c08afd90-f2a1-11d1-8455-00a0c91f3880} but parent command is explorer.exe\n        #  example:\n        #   \"C:\\Windows\\System32\\cmd.exe\" /Q /c cd \\ 1> \\\\127.0.0.1\\ADMIN$\\__1567520103.71 2>&1\n        # *** smbexec.py\n        #   parent is services.exe\n        #   example:\n        #       C:\\Windows\\system32\\cmd.exe /Q /c echo tasklist ^> \\\\127.0.0.1\\C$\\__output 2^>^&1 > C:\\Windows\\TEMP\\execute.bat & C:\\Windows\\system32\\cmd.exe /Q /c C:\\Windows\\TEMP\\execute.bat & del C:\\Windows\\TEMP\\execute.bat\n        ParentImage:\n            - '*\\wmiprvse.exe'  # wmiexec\n            - '*\\mmc.exe'  # dcomexec MMC\n            - '*\\explorer.exe'  # dcomexec ShellBrowserWindow\n            - '*\\services.exe'  # smbexec\n        CommandLine:\n            - '*cmd.exe* /Q /c * \\\\\\\\127.0.0.1\\\\*&1*'\n    selection_atexec:\n        ParentCommandLine:\n            - '*svchost.exe -k netsvcs' # atexec on win10 (parent is \"C:\\Windows\\system32\\svchost.exe -k netsvcs\")\n            - 'taskeng.exe*' # atexec on win7 (parent is \"taskeng.exe {AFA79333-694C-4BEE-910E-E57D9A3518F6} S-1-5-18:NT AUTHORITY\\System:Service:\")\n        # cmd.exe /C tasklist /m > C:\\Windows\\Temp\\bAJrYQtL.tmp 2>&1\n        CommandLine:\n            - 'cmd.exe /C *Windows\\\\Temp\\\\*&1'\n    condition: (1 of selection_*)\nfields:\n    - CommandLine\n    - ParentCommandLine\ntags:\n    - attack.lateral_movement\n    - attack.t1047\n    - attack.t1175\nfalsepositives:\n    - pentesters\nlevel: critical\n", "object_marking_refs": ["marking-definition--0a872d70-1d05-45dd-a25f-031af547a102"], "created_by_ref": "identity--082ca4f0-d825-45b6-aa42-ab9afd1e5503", "type": "indicator", "spec_version": "2.1", "id": "indicator--f35ad4c8-fc3d-4185-94bb-7ba0a178fdaa", "modified": "2020-04-02T10:14:35.276Z"}